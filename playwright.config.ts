import { defineConfig, devices } from "@playwright/test";
import { defineBddConfig } from "playwright-bdd";
import dotenv from "dotenv";

dotenv.config({ quiet: true });

// BDD 설정: feature/step 파일 경로 지정
const testDir = defineBddConfig({
  features: [
    "features/login.feature",
    "features/kpa-002.feature",
    "features/kpa-003.feature",
    "features/kpa-004.feature",
    "features/kpa-005.feature",
    "features/kpa-016.feature",
    "features/kpa-018.feature",
    "features/kpa-019.feature",
    "features/kpa-020.feature",
    "features/kpa-021.feature",
    "features/kpa-022.feature",
    "features/kpa-008.feature",
    "features/kpa-009.feature",
    "features/kpa-010.feature",
    "features/kpa-011.feature",
    "features/kpa-012.feature",
    "features/kpa-013.feature",
    "features/kpa-048.feature",
    "features/kpa-059.feature",
    "features/kpa-061.feature",
    "features/kpa-065.feature",
    "features/kpa-091.feature",
    "features/kpa-092.feature",
    "features/kpa-099.feature",
    "features/kpa-101.feature",
    "features/kpa-103.feature",
    "features/kpa-026.feature",
    "features/kpa-027.feature",
    "features/kpa-028.feature",
    "features/kpa-029.feature",
    "features/kpa-030.feature",
    "features/kpa-031.feature",
    "features/kpa-032.feature",
    "features/kpa-033.feature",
    "features/kpa-034.feature",
    "features/kpa-035.feature",
    "features/kpa-036.feature",
    "features/kpa-037.feature",
    "features/kpa-038.feature",
    "features/kpa-039.feature",
    "features/kpa-040.feature",
    "features/kpa-041.feature",
    "features/kpa-042.feature",
    "features/kpa-043.feature",
    "features/kpa-044.feature",
    "features/kpa-045.feature",
    "features/kpa-046.feature",
    "features/kpa-049.feature",
    "features/kpa-051.feature",
    "features/kpa-052.feature",
    "features/kpa-054.feature",
    "features/kpa-055.feature",
    "features/kpa-057.feature",
    "features/kpa-058.feature",
    "features/kpa-060.feature",
    "features/kpa-062.feature",
    "features/kpa-063.feature",
    "features/kpa-064.feature",
    "features/kpa-066.feature",
    "features/kpa-067.feature",
    "features/kpa-068.feature",
    "features/kpa-069.feature",
    "features/kpa-070.feature",
    "features/kpa-071.feature",
    "features/kpa-072.feature",
    "features/kpa-073.feature",
    "features/kpa-074.feature",
    "features/kpa-075.feature",
    "features/kpa-076.feature",
    "features/kpa-077.feature",
    "features/kpa-078.feature",
    "features/kpa-079.feature",
    "features/kpa-081.feature",
    "features/kpa-082.feature",
    "features/kpa-083.feature",
    "features/kpa-084.feature",
    "features/kpa-085.feature",
    "features/kpa-086.feature",
    "features/kpa-087.feature",
    "features/kpa-088.feature",
    "features/kpa-089.feature",
    "features/kpa-090.feature",
    "features/kpa-093.feature",
    "features/kpa-097.feature",
    "features/kpa-098.feature",
    "features/kpa-100.feature",
    "features/kpa-102.feature",
    "features/kpa-104.feature",
    "features/kpa-105.feature",
    "features/kpa-106.feature",
    "features/kpa-107.feature",
    "features/kpa-108.feature",
    "features/kpa-109.feature",
    "features/kpa-111.feature",
    "features/kpa-112.feature",
    "features/kpa-113.feature",
    "features/kpa-114.feature",
    "features/kpa-115.feature",
    "features/kpa-116.feature",
    "features/kpa-117.feature",
    "features/kpa-118.feature",
    "features/kpa-119.feature",
    "features/kpa-120.feature",
    "features/kpa-121.feature",
    "features/kpa-122.feature",
    "features/kpa-123.feature",
    "features/kpa-124.feature",
    "features/kpa-125.feature",
    "features/kpa-126.feature",
    "features/kpa-127.feature",
    "features/kpa-128.feature",
    "features/kpa-130.feature",
    "features/kpa-131.feature",
    "features/kpa-132.feature",
    "features/kpa-133.feature",
    "features/kpa-134.feature",
    "features/kpa-135.feature",
    "features/kpa-136.feature",
    "features/kpa-137.feature",
    "features/kpa-138.feature",
    "features/kpa-139.feature"
  ],
  steps: [
    "steps/fixtures.ts",
    "steps/common.navigation.steps.ts",
    "steps/common.auth.steps.ts",
    "steps/login.steps.ts",
    "steps/common.episode.steps.ts",
    "steps/kpa-002.steps.ts",
    "steps/kpa-003.steps.ts",
    "steps/kpa-004.steps.ts",
    "steps/kpa-005.steps.ts",
    "steps/kpa-016.steps.ts",
    "steps/kpa-018.steps.ts",
    "steps/kpa-019.steps.ts",
    "steps/kpa-020.steps.ts",
    "steps/kpa-021.steps.ts",
    "steps/kpa-022.steps.ts",
    "steps/kpa-008.steps.ts",
    "steps/kpa-009.steps.ts",
    "steps/kpa-010.steps.ts",
    "steps/kpa-011.steps.ts",
    "steps/kpa-012.steps.ts",
    "steps/kpa-013.steps.ts",
    "steps/kpa-048.steps.ts",
    "steps/kpa-059.steps.ts",
    "steps/kpa-061.steps.ts",
    "steps/kpa-065.steps.ts",
    "steps/kpa-091.steps.ts",
    "steps/kpa-092.steps.ts",
    "steps/kpa-099.steps.ts",
    "steps/kpa-101.steps.ts",
    "steps/kpa-103.steps.ts",
    "steps/kpa-026.steps.ts",
    "steps/kpa-027.steps.ts",
    "steps/kpa-028.steps.ts",
    "steps/kpa-029.steps.ts",
    "steps/kpa-030.steps.ts",
    "steps/kpa-031.steps.ts",
    "steps/kpa-032.steps.ts",
    "steps/kpa-033.steps.ts",
    "steps/kpa-034.steps.ts",
    "steps/kpa-035.steps.ts",
    "steps/kpa-036.steps.ts",
    "steps/kpa-037.steps.ts",
    "steps/kpa-038.steps.ts",
    "steps/kpa-039.steps.ts",
    "steps/kpa-040.steps.ts",
    "steps/kpa-041.steps.ts",
    "steps/kpa-042.steps.ts",
    "steps/kpa-043.steps.ts",
    "steps/kpa-044.steps.ts",
    "steps/kpa-045.steps.ts",
    "steps/kpa-046.steps.ts",
    "steps/kpa-049.steps.ts",
    "steps/kpa-051.steps.ts",
    "steps/kpa-052.steps.ts",
    "steps/kpa-054.steps.ts",
    "steps/kpa-055.steps.ts",
    "steps/kpa-057.steps.ts",
    "steps/kpa-058.steps.ts",
    "steps/kpa-060.steps.ts",
    "steps/kpa-062.steps.ts",
    "steps/kpa-063.steps.ts",
    "steps/kpa-064.steps.ts",
    "steps/kpa-066.steps.ts",
    "steps/kpa-067.steps.ts",
    "steps/kpa-068.steps.ts",
    "steps/kpa-069.steps.ts",
    "steps/kpa-070.steps.ts",
    "steps/kpa-071.steps.ts",
    "steps/kpa-072.steps.ts",
    "steps/kpa-073.steps.ts",
    "steps/kpa-074.steps.ts",
    "steps/kpa-075.steps.ts",
    "steps/kpa-076.steps.ts",
    "steps/kpa-077.steps.ts",
    "steps/kpa-078.steps.ts",
    "steps/kpa-079.steps.ts",
    "steps/kpa-081.steps.ts",
    "steps/kpa-082.steps.ts",
    "steps/kpa-083.steps.ts",
    "steps/kpa-084.steps.ts",
    "steps/kpa-085.steps.ts",
    "steps/kpa-086.steps.ts",
    "steps/kpa-087.steps.ts",
    "steps/kpa-088.steps.ts",
    "steps/kpa-089.steps.ts",
    "steps/kpa-090.steps.ts",
    "steps/kpa-093.steps.ts",
    "steps/kpa-097.steps.ts",
    "steps/kpa-098.steps.ts",
    "steps/kpa-100.steps.ts",
    "steps/kpa-102.steps.ts",
    "steps/kpa-104.steps.ts",
    "steps/kpa-105.steps.ts",
    "steps/kpa-106.steps.ts",
    "steps/kpa-107.steps.ts",
    "steps/kpa-108.steps.ts",
    "steps/kpa-109.steps.ts",
    "steps/kpa-111.steps.ts",
    "steps/kpa-112.steps.ts",
    "steps/kpa-113.steps.ts",
    "steps/kpa-114.steps.ts",
    "steps/kpa-115.steps.ts",
    "steps/kpa-116.steps.ts",
    "steps/kpa-117.steps.ts",
    "steps/kpa-118.steps.ts",
    "steps/kpa-119.steps.ts",
    "steps/kpa-120.steps.ts",
    "steps/kpa-121.steps.ts",
    "steps/kpa-122.steps.ts",
    "steps/kpa-123.steps.ts",
    "steps/kpa-124.steps.ts",
    "steps/kpa-125.steps.ts",
    "steps/kpa-126.steps.ts",
    "steps/kpa-127.steps.ts",
    "steps/kpa-128.steps.ts",
    "steps/kpa-130.steps.ts",
    "steps/kpa-131.steps.ts",
    "steps/kpa-132.steps.ts",
    "steps/kpa-133.steps.ts",
    "steps/kpa-134.steps.ts",
    "steps/kpa-135.steps.ts",
    "steps/kpa-136.steps.ts",
    "steps/kpa-137.steps.ts",
    "steps/kpa-138.steps.ts",
    "steps/kpa-139.steps.ts"
  ]
});

// CTO 시연용: 스텁만 있는 시나리오 제외. 정상 구현된 시나리오만 UI 모드에서 실행되도록 함
const STUB_KPA_NUMBERS = [
  32, 33, 34, 35, 55, 57, 58, 60, 62, 63, 64, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79,
  81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 93, 97, 98, 100, 102, 104, 105, 106, 107, 108, 109,
  111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128,
  130, 131, 132, 133, 134, 135, 136, 137, 138, 139
];
const STUB_TEST_IGNORE = STUB_KPA_NUMBERS.map((n) =>
  `**/kpa-${String(n).padStart(3, "0")}.feature.spec.js`
);

export default defineConfig({
  // BDD 설정을 테스트 디렉터리로 연결
  testDir,
  // 시나리오를 순차 실행
  workers: 1,
  fullyParallel: false,
  reporter: [
    ["html", { open: "never" }],
    ["list"],
    ["json", { outputFile: "test-results/results.json" }]
  ],
  timeout: 60000,
  expect: { timeout: 10000 },
  use: {
    headless: process.env.CI === "true",
    screenshot: "only-on-failure",
    trace: "on-first-retry",
    actionTimeout: 25000,
    navigationTimeout: 35000
  },
  // 프로젝트 1개만 두어 브라우저 1회만 실행. 성인 전용 필요 시 chromium-adult 프로젝트 다시 추가
  projects: [
    {
      name: "chromium",
      testIgnore: ["**/adult/**", ...STUB_TEST_IGNORE],
      use: {
        ...devices["Desktop Chrome"],
        channel: "chrome",
        launchOptions: {
          args: ["--disable-features=LocalNetworkAccess"]
        }
      }
    }
  ]
});
