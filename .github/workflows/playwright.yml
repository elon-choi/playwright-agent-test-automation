name: Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CI: true
  PLAYWRIGHT_BROWSERS_PATH: .playwright-browsers

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npm run pw:install

      - name: Run Playwright tests
        id: test
        run: npm run test

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TEST_EXIT_CODE: ${{ steps.test.outcome == 'failure' && 1 || 0 }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: npm run notify-slack

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 7

      - name: Setup Java (Allure CLI)
        if: always()
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Generate Allure report
        if: always()
        continue-on-error: true
        run: npx allure generate allure-results -o allure-report --clean

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results/
          retention-days: 14

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 14

  deploy-report-history:
    if: always() && !cancelled() && (github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare report-site (gh-pages content)
        run: |
          mkdir -p report-site/reports
          git fetch origin gh-pages 2>/dev/null || true
          git --work-tree=report-site checkout origin/gh-pages -- . 2>/dev/null || true

      - name: Set run id and date
        id: run
        run: |
          echo "id=$(date -u +%Y-%m-%d_%H-%M-%S)" >> $GITHUB_OUTPUT
          echo "date_iso=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Download Playwright report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - name: Add this run to report history
        run: |
          RUN_ID="${{ steps.run.outputs.id }}"
          RUN_DATE_ISO="${{ steps.run.outputs.date_iso }}"
          mkdir -p "report-site/reports/$RUN_ID"
          if [ -d playwright-report ] && [ -n "$(ls -A playwright-report 2>/dev/null)" ]; then
            cp -r playwright-report/* "report-site/reports/$RUN_ID/"
          else
            echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>No report</title></head><body><p>No report for this run.</p></body></html>' > "report-site/reports/$RUN_ID/index.html"
          fi
          RESULTS_JSON=test-results/results.json \
          SUMMARY_JSON="report-site/reports/$RUN_ID/summary.json" \
          RUN_DATE_ISO="$RUN_DATE_ISO" \
          RUN_ID="$RUN_ID" \
          node scripts/write-report-summary.mjs

      - name: Generate index
        run: REPORT_SITE=report-site node scripts/generate-report-index.mjs

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: report-site
          force_orphan: true
