# KPA-085-1 / 085-2 테스트 검증 보고

## 요약

- **목표:** 테스트 실행 → 실패 원인 수정 → 성공 시까지 검증 후 보고
- **결과:** 085-1·085-2 모두 **동일 단계에서 계속 실패**. 해당 단계까지는 수정 반영 후 정상 동작 확인.

---

## 1. 통과 구간 (수정 반영 완료)

다음 단계들은 수정 후 **정상 통과**합니다.

| 단계 | 내용 | 적용한 수정 |
|------|------|-------------|
| 로그인 ~ 이용권 내역 메뉴 | 접속, 로그인, 프로필, 이용권 내역 클릭 | - |
| 스크롤 다운으로 구매 내역 찾기 | 충전 내역 탭, 스크롤하며 무료/구매취소 제외한 행 탐색 | 리스트+윈도우 스크롤, 20회, `hasNotText: 무료/구매 취소`, locator 확대 |
| 대여권/소장권 행 클릭 | 구매 취소·무료 제외한 "대여권 n장"/"소장권 n장" 클릭 | `hasText: 대여권/소장권 n장`, `hasNotText: 무료, 구매 취소`, 캐시 조건 제거, 스크롤 루프(18회)로 행 탐색 |
| 대여권 n장 소장권 n장 > 클릭 | kpa-071 스텝 | - |
| 이용권 내역 팝업에서 타입 클릭 | 구매 취소할 대여권/소장권 타입 클릭 | `scrollIntoViewIfNeeded` + `force: true`, 1.5초 대기 추가 |

---

## 2. 실패 구간 (미해결)

**실패 단계:**  
`And 이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다`

**증상:**  
"구매 취소하기" 버튼을 **DOM에서 찾을 수 없음** (메인 문서·iframe·shadow DOM 모두 검색 후에도 없음).

**실패 시점 스냅샷:**  
- 작품 상세 페이지(content)만 보임 (예: 천마가 탑을 박살 냄).
- "대여권 15장", "소장권 0장", "1일 기다무 대여권 1장" 등은 보이나, **이용권 내역 상세 팝업/패널**과 **"구매 취소하기" 버튼**은 스냅샷/접근성 트리에 없음.

**가능한 원인:**

1. **상세 화면 미노출**  
   대여권/소장권 타입 클릭 후 "이용권 내역 상세"가 열리지 않거나, 다른 화면으로 전환됨.
2. **상세가 다른 문서에 있음**  
   상세가 별도 iframe(다른 origin) 등에만 렌더링되어 현재 페이지의 `page`로는 접근 불가.
3. **버튼 문구/구조 상이**  
   실제 서비스에서는 "구매 취소하기"가 아닌 다른 텍스트(예: "환불하기", "취소 신청")이거나, 버튼이 다른 태그/역할로 구현됨.
4. **조건부 노출**  
   특정 조건(구매 후 일정 시간 이내, 결제 수단 등)에서만 "구매 취소하기"가 노출됨.

---

## 3. 적용한 수정 요약 (구매 취소하기 스텝)

- 상세/팝업 대기: `유효기간|구매일|구매 취소|취소 하기` 등 10초 대기.
- 스크롤 대상 확대: dialog, modal, drawer, bottomSheet, sheet, Panel, main, `[class*="content"]` 등.
- 버튼 locator 확대: `구매 취소`, `취소 하기`, `구매취소하기` 등 여러 패턴, role=button/link + 텍스트.
- 20회 스크롤 루프 후 5초 대기로 버튼 재탐색.
- DOM 전체 + shadow DOM 순회하며 "구매 취소" 관련 텍스트 가진 클릭 가능 요소를 찾아 `click()` 하는 evaluate 폴백 추가.

위를 적용해도 **해당 버튼이 DOM에 존재하지 않아** 클릭까지 도달하지 못함.

---

## 4. 권장 사항 (테스트 성공을 위해)

1. **실제 서비스에서 플로우 확인**  
   - 이용권 내역 → (취소 가능한) 대여권/소장권 행 클릭 → 작품 상세 → "대여권 n장 소장권 n장" 옆 `>` 클릭 → 타입(예: 1일 기다무 대여권 1장) 클릭  
   - 이 직후 **어떤 화면이 열리는지**(같은 페이지 내 팝업/드로어 vs 새 탭/iframe vs URL 변경) 확인.

2. **"구매 취소하기" 버튼 실제 스펙 확인**  
   - 개발자 도구로 해당 화면에서 버튼 요소 확인:  
     - 노출되는 **정확한 텍스트**  
     - **태그**, **role**, **class**, **data 속성**  
     - **어떤 컨테이너 안에 있는지** (예: `[role="dialog"]` 내부, 특정 class 패널 등).

3. **선택자/스텝 반영**  
   - 확인한 텍스트·구조에 맞게 `steps/kpa-085-1.steps.ts` 의 "이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다" 스텝에서:  
     - `getByText` / `getByRole` 패턴을 실제 문구·역할에 맞게 수정하고,  
     - 필요 시 상세가 열리는 **컨테이너(dialog/iframe)** 를 먼저 찾은 뒤, 그 안에서만 버튼을 찾도록 수정.

4. **환불 가능한 테스트 데이터**  
   - 취소 가능한 대여권/소장권(구매 취소 가능 기간·조건 충족)으로 동일 플로우를 수동 재현해, "구매 취소하기"가 실제로 노출되는지 확인.

---

## 5. 수정된 파일 목록

- `steps/kpa-085-1.steps.ts`  
  - 스크롤·대여권/소장권 행 찾기·타입 클릭·구매 취소하기 스텝 전반 수정 (위 1·3절 반영).
- `features/kpa-085-1.feature`, `features/kpa-085-2.feature`  
  - "구매 취소 처리되지 않은" 구매한 대여권/소장권 영역 클릭하도록 시나리오 문구 반영 (기존 대화 내용 기준).

---

**보고 일자:** 2026-02-16  
**테스트 실행:** Playwright chromium, `kpa-085-1.feature.spec.js`, `kpa-085-2.feature.spec.js`

---

## 6. 2026-02-17 수정 및 재실행 결과

### 6.1 사용자 요청 반영 수정

| 요청 | 적용 내용 |
|------|-----------|
| 스크롤 다운 속도가 빨라 취소 가능한 대여권 영역을 찾지 못함 | 스크롤량 350px → **120px**, 스크롤 후 대기 450ms → **850ms**, 최대 반복 20 → **40**. 행 찾을 때 **scrollIntoViewIfNeeded** 후 500ms 대기. 클릭 스텝의 스크롤 루프도 120px/750ms/25회로 통일. |
| 대여권 n장 소장권 n장 > 영역을 클릭하지 못함 | kpa-071: **대여권/소장권 포함 컨테이너** 우선 탐색 (`[class*="ticket"], [class*="Ticket"], [class*="item"], [class*="row"]` + hasText 대여권/소장권). byText, byRole, rowWithTicket, fallback 순으로 재시도(6회). scrollIntoView 및 500ms 대기 추가. |

### 6.2 추가 보강

- **소장권 타입 클릭 (085-2):** 팝업 로드 1초 대기, `waitForLoadState`, 무료아님 locator에 row 추가, getByText + rowWithNum(소장권+숫자+장) 폴백.
- **구매 취소하기 버튼:** tryClickCancel 헬퍼로 role/텍스트/filter 3종 시도. 스크롤 20회, 팝업에서 못 찾으면 **메인 page**에서도 동일 locator로 시도.

### 6.3 재실행 결과 (헤디드)

| 스펙 | 결과 | 실패 단계 |
|------|------|------------|
| KPA-085-1 | 실패 | `충전 내역 탭에서 구매한 대여권 영역을 클릭한다` – **취소 가능한 대여권 항목 없음** |
| KPA-085-2 | 실패 | `이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다` – **구매 취소하기 버튼 미발견** |

- **085-1:** 에러 컨텍스트 상 충전 내역에 **소장권**만 있고, 대여권은 모두 "무료 대여권" 또는 "신규혜택 무료 대여권"으로만 존재. **취소 가능한 유료 대여권이 테스트 계정에 없어** 해당 스텝에서 정상적으로 실패. → 테스트 데이터(유료 대여권 1건 이상) 확보 후 재실행 필요.
- **085-2:** 스크롤/대여권 n장 소장권 n장 클릭/소장권 타입 클릭까지 **진행됨**. 실패 시점 스냅샷은 **흑백무제 4화 뷰어 페이지** – 팝업이 닫혔거나 팝업이 뷰어로 이동한 상태로 추정. 팝업·메인 양쪽에서 구매 취소하기를 찾도록 폴백을 넣었으나, 현재 환경에서는 버튼 미노출.

### 6.4 수정된 파일 (본 회차)

- `steps/kpa-085-1.steps.ts`: 스크롤 속도/량, 스크롤 루프 대기·횟수, 구매 취소하기 tryClickCancel·팝업/메인 이중 시도, 소장권 타입 클릭 보강.
- `steps/kpa-071.steps.ts`: 대여권 n장 소장권 n장 > 영역 클릭을 컨테이너 우선·다중 locator·재시도로 보강.

---

## 7. 2026-02-17 실패 로그·덤프 기반 수정 및 재실행

### 7.1 확인한 자료

- **실패 로그:** `test-results/features-kpa-085-1.feature-*/error-context.md`, `features-kpa-085-2.feature-*/error-context.md`
- **덤프:** `dom_dumps/*.html` (실패 시점 페이지는 error-context 스냅샷으로 확인)

### 7.2 error-context에서 확인한 내용

- **085-1:** 이용권 내역·충전 내역 탭에서 `link "흑백무제 100캐시 소장권 1장"`, `link "개미 -500캐시 소장권 1장"` 등 **소장권** 링크는 존재. **대여권**은 "0캐시", "무료 대여권"만 있어 유료 대여권 행이 없음.
- **085-2:** 동일 리스트에서 "흑백무제 100캐시 소장권 1장" 등 **유료 소장권** 행 존재. 실패 직전 단계 통과 후 "구매 취소하기" 단계에서 실패 시 스냅샷은 **뷰어 페이지(흑백무제 6화)** 로, 팝업이 닫혔거나 뷰어로 전환된 상태로 추정.

### 7.3 적용한 수정

| 구분 | 수정 내용 |
|------|-----------|
| 행 locator | `getByRole("link")` → `locator('a[href*="content"], a[href*="ticket"]')` 로 변경. 유료 구분을 `hasNotText: "0캐시"` → `hasText: /-?[1-9]\d*캐시/` 로 변경(0캐시 제외, 100캐시·-500캐시 등만 매칭). |
| 리스트 대기 | 각 클릭 스텝 앞에 `waitForSelector('a[href*="content"]', { state: "attached", timeout: 15000 })` 및 800ms 대기 추가. |
| 스크롤·클릭 루프 | 35회 스크롤 루프, 매 회 `rowLocator.count()` 확인 후 보이는 행 중 첫 번째 클릭. |
| Fallback | 대여권: `a[href*="content"]` + "대여권" + hasNotText 구매취소/무료. 소장권: `a[href*="content"]` + "소장권" + hasNotText 구매취소. |
| 찾기 스텝 | `paidRowLocator`에 `hasText: /-?[1-9]\d*캐시/` 적용. |
| 구매 취소하기 | 팝업에서 버튼 12초 대기 후 스크롤·클릭, 실패 시 **메인 page**에서 동일 locator로 재시도. |

### 7.4 최종 재실행 결과

| 스펙 | 결과 | 실패 단계 |
|------|------|------------|
| KPA-085-1 | 실패 | `충전 내역 탭에서 구매한 대여권 영역을 클릭한다` – 테스트 계정에 **유료 대여권** 행이 없음(0캐시·무료 대여권만 존재). Fallback도 대여권 행 없으면 실패. |
| KPA-085-2 | 실패 | `이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다` – **소장권 영역 클릭**까지 통과. 이후 팝업/메인에서 "구매 취소하기" 버튼 미발견(팝업이 뷰어로 전환된 상태 추정). |

### 7.5 결론 및 권장 사항

- **085-1:** 코드 상으로는 유료 대여권 행(대여권 + `-?[1-9]\d*캐시`) 및 fallback으로 찾도록 되어 있음. **실제 계정에 취소 가능한 유료 대여권이 1건 이상 있어야** 해당 스텝 통과 가능.
- **085-2:** 소장권 행 찾기·클릭은 수정 후 **통과**. 실패는 "구매 취소하기" 단계로, 레코딩대로라면 해당 버튼은 **팝업**에 있으나, 현재 실행에서는 소장권 타입 클릭 후 팝업이 **뷰어**로 바뀌어 버튼이 없음. 수동으로 같은 플로우를 재현해 "구매 취소하기"가 **어느 페이지(팝업/메인/모달)** 에, **어떤 조건**에서 노출되는지 확인 후, 필요 시 해당 컨텍스트만 대상으로 locator·스텝 보강 필요.

### 7.6 수정된 파일 (본 회차)

- `steps/kpa-085-1.steps.ts`: 행 locator(a[href*="content"], -?[1-9]\d*캐시), waitForSelector, 35회 스크롤 루프, 대여권/소장권 fallback, 구매 취소하기 팝업+메인 시도.

---

## 8. 2026-02-17 행 locator 수정 후 직접 실행 결과

### 8.1 적용한 수정

- **`hasNotText: /구매\s*취소/` 제거**  
  취소 가능한 행에는 "구매 취소" 텍스트가 **같은 행 안에** 있으므로, 해당 조건을 제거해 취소 가능한 대여권/소장권 행이 locator에 포함되도록 함.
- **캐시 필터:** `/-?[1-9]\d*캐시/` → `/[1-9]\d*캐시|-?\d+캐시/` 로 통일 (예: -100캐시, -500캐시 매칭).
- **소장권 fallback:** "구매 취소 처리되지 않은 구매한 소장권 영역을 클릭한다" 스텝에 fallback 소장권 locator + 클릭 후 throw 하도록 추가.

### 8.2 실행 환경

- **명령:** `PLAYWRIGHT_BROWSERS_PATH=.playwright-browsers npx playwright test .features-gen/features/kpa-085-1.feature.spec.js .features-gen/features/kpa-085-2.feature.spec.js --project=chromium --reporter=list`
- **실행 일시:** 2026-02-17
- **소요:** 085-1 약 1.2분, 085-2 약 49초

### 8.3 실행 결과 요약

| 스펙 | 결과 | 실패 단계 |
|------|------|-----------|
| KPA-085-1 | **실패** | `이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다` |
| KPA-085-2 | **실패** | `이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다` |

- **085-1:** "충전 내역 탭에서 구매 취소 처리되지 않은 구매한 대여권 영역을 클릭한다" 단계 **통과**. 이후 "대여권 n장 소장권 n장 >" 클릭 → "구매를 취소할 대여권 타입을 클릭한다"까지 진행된 뒤, "구매 취소하기 버튼을 클릭한다"에서 실패.
- **085-2:** "충전 내역 탭에서 구매 취소 처리되지 않은 구매한 소장권 영역을 클릭한다" 단계 **통과**. 동일하게 "구매 취소하기 버튼을 클릭한다"에서 실패.

### 8.4 실패 시점 페이지 (error-context 스냅샷)

- **085-1:** **개미 12화** 작품 상세/뷰어 화면 ("개미 12화 \| 카카오페이지", "다음화 미리보기", "이 작품과 함께보는 웹툰" 등).
- **085-2:** **흑백무제 12화** 뷰어 화면 ("흑백무제 12화 \| 카카오페이지", "테마, 글꼴, 글자 크기...", "이전/다음" 등).

즉, 실패 시점에는 **이용권 내역 상세 팝업이 아닌 웹툰 뷰어(또는 작품 상세) 페이지**가 활성화되어 있어, "구매 취소하기" 버튼이 현재 페이지 DOM에 없음.

### 8.5 결론

1. **행 locator 수정은 유효함.**  
   `hasNotText: /구매\s*취소/` 제거 후, 취소 가능한 대여권/소장권 **행을 찾고 클릭하는 단계**는 두 시나리오 모두 통과함.
2. **현재 실패 원인은 "구매 취소하기" 단계 이전 플로우.**  
   행 클릭 → 작품 상세/뷰어로 이동 → "대여권 n장 소장권 n장 >" 클릭 시 **팝업이 열리지 않거나, 곧바로 뷰어로 전환**되는 것으로 추정. 따라서 "이용권 내역 상세 팝업"이 유지되지 않은 상태에서 "구매 취소하기"를 찾으려 해 실패함.
3. **권장 사항 (기존 §4·§7과 동일):**  
   - 수동으로 동일 플로우(이용권 내역 → 취소 가능 행 클릭 → "대여권 n장 소장권 n장 >" 클릭 → 타입 클릭)를 재현해, **팝업이 열리는지**, **"구매 취소하기"가 어느 컨테이너(팝업/메인/모달)에 노출되는지** 확인.  
   - "대여권 n장 소장권 n장 >" 클릭 스텝(kpa-071)에서 **팝업이 실제로 열리도록** 할 수 있는지(예: 클릭 대상·대기 조건 조정) 검토.

---

## 9. 2026-02-17 스크롤·팝업/메인 이중 대상 수정 후 실행 결과

### 9.1 적용한 수정

- **구매 취소하기 스텝:** 이용권 내역 상세 로드 대기 → 팝업 내부 끝까지 스크롤(여러 컨테이너) → "구매 취소" / "구매 취소하기" 버튼·링크 다중 선택자 → **팝업이 닫혀 있으면 메인 페이지**에서 상세 URL/텍스트 확인 후 동일하게 스크롤·클릭 시도.
- **토스트 검증 스텝:** 팝업·메인 페이지 모두에서 토스트 문구 검사, "취소되었습니다" 패턴 및 "구매 취소 불가" fallback을 팝업/메인 둘 다 확인하도록 수정.

### 9.2 실행 결과 요약

| 스펙 | 결과 | 실패 단계 |
|------|------|-----------|
| KPA-085-1 | **실패** | `이용권 또는 소장권이 취소 되었습니다. 토스트 메세지가 노출되는 걸 확인한다` |
| KPA-085-2 | **실패** | `이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다` |

- **085-1:** **구매 취소하기 버튼 클릭까지 통과.** 확인 클릭 후 토스트 검증에서 실패(토스트 미노출 또는 팝업/메인 어디에도 해당 텍스트 미발견). 토스트 스텝을 팝업·메인 이중 확인 및 패턴 확장으로 수정함.
- **085-2:** 소장권 플로우는 여전히 "구매 취소하기 버튼을 클릭한다" 단계에서 실패(팝업이 닫히거나 뷰어로 전환되어 버튼 미노출로 추정).

### 9.3 결론

- 085-1은 **구매 취소 플로우(스크롤 → 구매 취소하기 클릭)** 가 동작함. 토스트 검증만 보강 완료.
- 085-2는 대여권과 동일한 스텝을 쓰지만, 소장권 타입 클릭 후에는 상세 팝업/메인에 "구매 취소" 버튼이 안 보이는 환경으로 보임. 수동으로 소장권 취소 플로우를 재현해 버튼 노출 위치를 확인하는 것이 필요함.

---

## 10. 최근 테스트 실행 결과 (보고 요청 시점)

### 10.1 실행 개요

- **대상:** KPA-085-1 (대여권 환불), KPA-085-2 (소장권 환불)
- **명령:** `PLAYWRIGHT_BROWSERS_PATH=.playwright-browsers npx playwright test .features-gen/features/kpa-085-1.feature.spec.js .features-gen/features/kpa-085-2.feature.spec.js --project=chromium --reporter=list`
- **결과:** **2건 모두 실패**

### 10.2 KPA-085-1 (대여권 환불)

| 항목 | 내용 |
|------|------|
| **실패 단계** | `이용권 내역 팝업창에서 구매를 취소할 대여권 타입을 클릭한다` |
| **에러** | `TimeoutError: locator.click: Timeout 15000ms exceeded.` |
| **대기 locator** | `getByText(/대여권\s*[1-9]\d*\s*장\|대여권\s*1\s*장/).first()` |
| **소요** | 약 1.4분 |

유료 대여권 행(무료아님, 링크 행, 화살표 포함 행)을 찾지 못해 fallback(대여권 n장 텍스트)까지 진행된 뒤, 해당 요소 클릭에서 15초 타임아웃. 팝업이 열리지 않았거나, 팝업/메인 중 어느 쪽에서도 “대여권 1장” 등 리스트 행이 보이지 않는 상황으로 추정.

### 10.3 KPA-085-2 (소장권 환불)

| 항목 | 내용 |
|------|------|
| **실패 단계** | `이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다` |
| **에러** | `구매 취소하기 버튼을 찾을 수 없습니다. 이용권 내역 상세 팝업에서 화면 하단으로 스크롤한 뒤 '구매 취소' 버튼이 노출되는지 확인하세요.` |
| **소요** | 약 59초 |

팝업/메인 스크롤, 버튼·링크·텍스트 locator, evaluate 폴백까지 수행했으나 “구매 취소”/“구매 취소하기” 버튼 미발견. 소장권 타입 클릭 후 상세 화면이 열리지 않거나, 뷰어 등 다른 화면으로 전환된 상태로 추정.

### 10.4 결론 및 권장

- **085-1:** “대여권 n장 소장권 n장 >” 클릭 후 **이용권 내역 팝업**이 열리고, 그 안에 **대여권 1장(또는 유료 대여권) 행**이 노출되는지 수동으로 확인 필요. 팝업이 안 열리거나 다른 창으로 열리면 `__ticketPopup` 또는 메인 페이지 컨텍스트를 점검해야 함.
- **085-2:** 소장권 타입 클릭 직후 **이용권 내역 상세**가 열리고, 하단 스크롤 시 **구매 취소(하기)** 버튼이 노출되는지 수동 재현 후 DOM/URL 확인 필요.
