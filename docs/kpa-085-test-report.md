# KPA-085-1 / 085-2 테스트 검증 보고

## 요약

- **목표:** 테스트 실행 → 실패 원인 수정 → 성공 시까지 검증 후 보고
- **결과:** 085-1·085-2 모두 **동일 단계에서 계속 실패**. 해당 단계까지는 수정 반영 후 정상 동작 확인.

---

## 1. 통과 구간 (수정 반영 완료)

다음 단계들은 수정 후 **정상 통과**합니다.

| 단계 | 내용 | 적용한 수정 |
|------|------|-------------|
| 로그인 ~ 이용권 내역 메뉴 | 접속, 로그인, 프로필, 이용권 내역 클릭 | - |
| 스크롤 다운으로 구매 내역 찾기 | 충전 내역 탭, 스크롤하며 무료/구매취소 제외한 행 탐색 | 리스트+윈도우 스크롤, 20회, `hasNotText: 무료/구매 취소`, locator 확대 |
| 대여권/소장권 행 클릭 | 구매 취소·무료 제외한 "대여권 n장"/"소장권 n장" 클릭 | `hasText: 대여권/소장권 n장`, `hasNotText: 무료, 구매 취소`, 캐시 조건 제거, 스크롤 루프(18회)로 행 탐색 |
| 대여권 n장 소장권 n장 > 클릭 | kpa-071 스텝 | - |
| 이용권 내역 팝업에서 타입 클릭 | 구매 취소할 대여권/소장권 타입 클릭 | `scrollIntoViewIfNeeded` + `force: true`, 1.5초 대기 추가 |

---

## 2. 실패 구간 (미해결)

**실패 단계:**  
`And 이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다`

**증상:**  
"구매 취소하기" 버튼을 **DOM에서 찾을 수 없음** (메인 문서·iframe·shadow DOM 모두 검색 후에도 없음).

**실패 시점 스냅샷:**  
- 작품 상세 페이지(content)만 보임 (예: 천마가 탑을 박살 냄).
- "대여권 15장", "소장권 0장", "1일 기다무 대여권 1장" 등은 보이나, **이용권 내역 상세 팝업/패널**과 **"구매 취소하기" 버튼**은 스냅샷/접근성 트리에 없음.

**가능한 원인:**

1. **상세 화면 미노출**  
   대여권/소장권 타입 클릭 후 "이용권 내역 상세"가 열리지 않거나, 다른 화면으로 전환됨.
2. **상세가 다른 문서에 있음**  
   상세가 별도 iframe(다른 origin) 등에만 렌더링되어 현재 페이지의 `page`로는 접근 불가.
3. **버튼 문구/구조 상이**  
   실제 서비스에서는 "구매 취소하기"가 아닌 다른 텍스트(예: "환불하기", "취소 신청")이거나, 버튼이 다른 태그/역할로 구현됨.
4. **조건부 노출**  
   특정 조건(구매 후 일정 시간 이내, 결제 수단 등)에서만 "구매 취소하기"가 노출됨.

---

## 3. 적용한 수정 요약 (구매 취소하기 스텝)

- 상세/팝업 대기: `유효기간|구매일|구매 취소|취소 하기` 등 10초 대기.
- 스크롤 대상 확대: dialog, modal, drawer, bottomSheet, sheet, Panel, main, `[class*="content"]` 등.
- 버튼 locator 확대: `구매 취소`, `취소 하기`, `구매취소하기` 등 여러 패턴, role=button/link + 텍스트.
- 20회 스크롤 루프 후 5초 대기로 버튼 재탐색.
- DOM 전체 + shadow DOM 순회하며 "구매 취소" 관련 텍스트 가진 클릭 가능 요소를 찾아 `click()` 하는 evaluate 폴백 추가.

위를 적용해도 **해당 버튼이 DOM에 존재하지 않아** 클릭까지 도달하지 못함.

---

## 4. 권장 사항 (테스트 성공을 위해)

1. **실제 서비스에서 플로우 확인**  
   - 이용권 내역 → (취소 가능한) 대여권/소장권 행 클릭 → 작품 상세 → "대여권 n장 소장권 n장" 옆 `>` 클릭 → 타입(예: 1일 기다무 대여권 1장) 클릭  
   - 이 직후 **어떤 화면이 열리는지**(같은 페이지 내 팝업/드로어 vs 새 탭/iframe vs URL 변경) 확인.

2. **"구매 취소하기" 버튼 실제 스펙 확인**  
   - 개발자 도구로 해당 화면에서 버튼 요소 확인:  
     - 노출되는 **정확한 텍스트**  
     - **태그**, **role**, **class**, **data 속성**  
     - **어떤 컨테이너 안에 있는지** (예: `[role="dialog"]` 내부, 특정 class 패널 등).

3. **선택자/스텝 반영**  
   - 확인한 텍스트·구조에 맞게 `steps/kpa-085-1.steps.ts` 의 "이용권 내역 상세 팝업창에서 스크롤 다운 후 구매 취소하기 버튼을 클릭한다" 스텝에서:  
     - `getByText` / `getByRole` 패턴을 실제 문구·역할에 맞게 수정하고,  
     - 필요 시 상세가 열리는 **컨테이너(dialog/iframe)** 를 먼저 찾은 뒤, 그 안에서만 버튼을 찾도록 수정.

4. **환불 가능한 테스트 데이터**  
   - 취소 가능한 대여권/소장권(구매 취소 가능 기간·조건 충족)으로 동일 플로우를 수동 재현해, "구매 취소하기"가 실제로 노출되는지 확인.

---

## 5. 수정된 파일 목록

- `steps/kpa-085-1.steps.ts`  
  - 스크롤·대여권/소장권 행 찾기·타입 클릭·구매 취소하기 스텝 전반 수정 (위 1·3절 반영).
- `features/kpa-085-1.feature`, `features/kpa-085-2.feature`  
  - "구매 취소 처리되지 않은" 구매한 대여권/소장권 영역 클릭하도록 시나리오 문구 반영 (기존 대화 내용 기준).

---

**보고 일자:** 2026-02-16  
**테스트 실행:** Playwright chromium, `kpa-085-1.feature.spec.js`, `kpa-085-2.feature.spec.js`
