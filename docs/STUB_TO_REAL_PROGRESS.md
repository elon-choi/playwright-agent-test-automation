# 스텁 → 정상 시나리오 전환 진행 상황

스텁(waitForTimeout 위주) 시나리오를 실제 동작으로 전환하는 작업 로그입니다.

## 원칙

- **스텁으로 성공 처리 금지**: 모든 스텝은 실제 locator/click/expect 또는 명시적 실패·스킵만 사용.
- 로그인 필요 시나리오는 `accounts.kakao.com` 감지 시 `"로그인 상태가 필요합니다. 00-login.feature을 먼저 실행해 주세요."` 로 실패.

## 전제 조건

- **로그인**: 보관함/최근본/이용권 등 시나리오는 `.auth` 저장소가 있어야 함.  
  `npx playwright test --project=chromium 00-login` 또는 해당 로그인 시나리오를 먼저 실행해 두기.

## 처음 만나는 독자 혜택 팝업 (공통 시나리오 / if 제어)

웹소설 작품을 처음 진입하면 "처음 만나는 독자 혜택" 대여권 안내 팝업이 뜰 수 있다. BDD에서 **있을 때만** 닫도록 공통 시나리오로 반영했다.

- **공통 스텝 구현** (`steps/common.episode.steps.ts`):  
  - `dismissFirstTimeReaderBenefitIfPresent(page)`: "처음 만나는 독자 혜택" 또는 "대여권 … 받았습니다" 문구가 있으면 **확인** 버튼 클릭.  
  - 다음 스텝 내부에서 위 함수 호출: `ensureContentPage`(작품 상세 이동 직후), "사용자가 특정 작품홈에 진입한다", "무료 회차에 진입한다", "무료 회차 목록에 진입한다", "전체 연령 작품의 무료 회차에 진입한다", "전체 연령 작품 목록에서 무료 회차를 선택한다".
- **BDD 스텝**: `And 사용자가 처음 만나는 독자 혜택 팝업이 있으면 확인을 눌러 닫는다`  
  작품홈/작품 상세 진입이 있는 **모든** feature 시나리오에, 진입 직후 한 줄씩 추가해 두었음 (kpa-011, 012, 091, 092, 109, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 130, 131, 132, 133, 134, 135, 136, 137 등).

## PCW 전체 테스트 반영 수정 (실패 4건 + KPA-059)

PCW(chromium) 전체 실행 결과 반영.

| KPA | 수정 내용 |
|-----|-----------|
| 059 | `waitForLoadState("domcontentloaded")`에 `{ timeout: 15000 }` 추가. 무한 로딩처럼 보이던 구간 제한. |
| 055 | "해당 작품의 1회차를 클릭하여 감상한다" 전에 이용권 수령 팝업(`[data-t-obj*="이용권수령팝업"]` 또는 fixed z-100)이 있으면 확인 버튼 클릭 후 1회차 클릭. |
| 063 | "임의의 작품을 클릭한다"에서 클릭할 링크의 href를 확보해 `setSelectedWorkUrl(href)` 호출. kpa-061에 `setSelectedWorkUrl` export 추가. Then "클릭한 작품의 작품홈으로 이동한다"가 올바른 URL로 검증. |
| 093 | "사용자가 특정 [회차]를 클릭한다": scrollIntoView, force click, evaluate fallback, waitForURL 20초. Then "해당 회차의 뷰어 페이지로 이동한다": toHaveURL timeout 15초. |
| 107 | "더보기 레이어 팝업이 노출되어야 한다" 스텝이 kpa-070.steps와 kpa-107.steps에 중복 정의되어 Multiple definitions 에러 발생. kpa-107.steps의 Then 정의 제거, kpa-070의 Then을 신고하기/차단하기/취소 옵션까지 검사하도록 확장해 KPA-107에서도 사용. |

## KPA-085-1 / 085-2 이용권 환불 (대여권·소장권 분리, 이용권 내역 경로)

081(대여권 구매), 082(소장권 구매)와 분리해 **프로필 → 이용권 내역 → 충전 내역** 경로로 환불만 검증.

| 구분 | 내용 |
|------|------|
| 1. 081 | 대여권 구매 검증 (기존 유지) |
| 2. 082 | 소장권 구매 검증 (기존 유지) |
| 3. 085-1 대여권 | 로그인 → 프로필 → 이용권 내역 → 충전 내역 탭에서 구매한 대여권 영역 클릭 → (작품홈) > 아이콘 → 대여권 타입 클릭 → 상세에서 구매 취소하기 → 확인 → 토스트 확인 → 닫기 |
| 4. 085-2 소장권 | 로그인 → 프로필 → 이용권 내역 → 충전 내역 탭에서 구매한 소장권 영역 클릭 → (작품홈) > 아이콘 → 소장권 타입 클릭 → 상세에서 구매 취소하기 → 확인 → 토스트 확인 → 닫기 |

- **feature**: `features/kpa-085-1.feature` (대여권 1개 시나리오), `features/kpa-085-2.feature` (소장권 1개 시나리오)
- **steps**: `steps/kpa-085-1.steps.ts` — 이용권 내역 메뉴, 스크롤 후 구매 내역 찾기, 충전 내역에서 대여권/소장권 영역 클릭, 팝업에서 취소할 타입 클릭, 상세에서 구매 취소하기·확인·토스트·닫기. 프로필 클릭은 kpa-002, `대여권 n장 소장권 n장 >` 클릭은 kpa-071 재사용.

## 완료된 수정 (배치 1)

| KPA | 내용 | 비고 |
|-----|------|------|
| 032 | 정렬 선택(스텁 제거), 랭킹 1위·1회차 클릭(실제 이동·클릭), 리스트 확인·정렬/감상/이력 검증(expect) | 로그인 필요 |
| 033 | 최근본 탭 이동·리스트 존재 검증, 최근본 탭 클릭, 검색 아이콘·검색어·검색 버튼·결과 표시(실제 동작+expect) | 로그인 필요 |
| 034 | 최근본 탭 클릭, 작품 리스트 확인(리스트 또는 빈 상태 문구 expect), 편집·선택·삭제 버튼·삭제 검증 | 로그인 필요 |
| 035 | 정렬 옵션 노출 Then을 실제 텍스트 expect로 변경 (기존 kpa-040 정렬 클릭 사용) | 로그인 필요 |
| 070 | 더보기 버튼 클릭(작품 진입 후), 팝업 노출·옵션·취소 클릭·닫힘 검증(expect) | 작품홈 필요, 로그인 권장 |
| kpa-037 | When "하단의 보관함 메뉴를 클릭" 시 로그인 페이지 감지 시 즉시 실패, 이미 inven이면 스킵, inven 링크/직접 이동 fallback | 공통 |

## 완료된 수정 (배치 2)

| KPA | 내용 | 비고 |
|-----|------|------|
| 055 | 웹소설 GNB 클릭, 보관함 최근본 리스트 노출, 메인홈→웹소설→랭킹 2위 클릭, 1회차 감상, 뷰어 검증, 추천탭 최근본 영역·첫 번째 작품 이력 expect | 로그인 필요 |
| 093 | 무료/일반 회차 페이지 진입(작품 카드 클릭), 회차 리스트 표시 expect, 특정 회차 클릭, 뷰어 URL·화면 검증 | 공통 |

## 완료된 수정 (배치 3 - 5개 단위)

| KPA | 내용 | 비고 |
|-----|------|------|
| 033 | STUB 제거, 기존 실제 구현으로 chromium 실행 | 로그인 필요 |
| 034 | STUB 제거, 기존 실제 구현으로 chromium 실행 | 로그인 필요 |
| 035 | STUB 제거, 기존 실제 구현으로 chromium 실행 | 로그인 필요 |
| 057 | 책 GNB 실제 클릭 구현, 배너 스텝은 kpa-048 공유, "배너는 다음 요소들로 구성된다" 048에 별칭 추가 | 로그인 필요 |
| 058 | 책 GNB·보관함 최근본·랭킹 1위(스크롤+dispatchEvent 클릭)·1회차(055 공유)·뷰어 검증·추천탭 최근본(055 공유)·첫 번째 이력 expect | 로그인 필요 |

## 완료된 수정 (배치 4 - 5개 단위)

| KPA | 내용 | 비고 |
|-----|------|------|
| 060 | 추천 GNB(common)·실시간 랭킹 서브탭·웹툰 탭·1위 작품 클릭(스크롤+dispatchEvent)·랭킹 하단 요소/1위 홈 이동 expect | 공통 |
| 064 | 웹소설 GNB(055)·장르전체 서브탭·임의 작품(027 공유)·장르전체 UI 노출 expect·작품 홈(046 공유) | 공통 |
| 066 | 페이지 로드 시 작품홈 진입(ensureOnWorkHome)·작품명/작가/장르/열람·좋아요 영역 expect | 공통 |
| 067 | 작품홈 진입(ensureOnWorkHome)·BM 영역(뱃지/이미지) expect | 공통 |
| 068 | 로그인·작품홈 진입·좋아요 클릭·보관함·좋아요 탭·활성화/작품 노출 expect | 로그인 필요 |

## 완료된 수정 (배치 5 - 배치3)

| KPA | 내용 | 비고 |
|-----|------|------|
| 069 | 로그인·좋아요 활성 상태(작품홈)·좋아요 클릭 비활성화·보관함·좋아요 탭·해당 작품 미노출 검증 | 로그인 필요 |
| 072 | 탭 영역 하단 배너 확인·클릭(main 링크)·랜딩 URL 이동 expect | 공통 |
| 073 | 모바일 뷰포트·첫 화 보기 탭·스크롤·뷰어로 보기·연재/줄거리/뷰어 검증 | 모바일 뷰포트 |
| 074 | 모바일 Given·최하단 스크롤·[다음화 보기] 클릭·[다음 회차]·다음 회차 뷰어 검증 | 모바일 뷰포트 |
| 075 | 모바일 Given·첫 화 보기 탭·스크롤·[뷰어로 보기]·이펍 뷰어 노출 검증 | 모바일 뷰포트 |

## 완료된 수정 (배치 5 - 070, 087, 088, 089, 090)

| KPA | 내용 | 비고 |
|-----|------|------|
| 070 | STUB 제거. MW는 더보기 버튼 클릭·팝업·취소 검증 구현 유지. PCW는 PC Web 미지원으로 스킵 | MW 통과, PCW 스킵 |
| 087 | ensureOnWorkHome, 기다무/대여권/충전 텍스트 검증, 기다무 충전 영역 정보(남음/분/일/시간) expect | 공통 |
| 088 | 작품홈 진입, 기다무 충전 영역 클릭(스크롤+closest a/button 클릭), 기다무 안내 팝업·이용권/무료/회차/닫기 검증 | 공통 |
| 089 | 로그인 필요 시 실패, ensureOnWorkHome, 구매회차 메뉴 클릭, 구매회차 목록/뷰어 링크 노출 검증 | 로그인 필요 |
| 090 | 로그인 필요, ensureOnWorkHome, 구매한 회차 없음 메시지 또는 구매/회차 탭 존재 검증, Then import 추가 | 로그인 필요 |

## 테스트 실행

**필수: 로그인 상태가 없으면 032, 033, 034, 035, 070은 "로그인 상태가 필요합니다"로 실패합니다. 스텁으로 통과하지 않습니다.**

```bash
# 로그인 상태 생성 (최초 1회)
PLAYWRIGHT_BROWSERS_PATH=.playwright-browsers npx playwright test --project=chromium features/00-login.feature

# 스텁 전환 배치 실행 (032,033,034,035,070)
PLAYWRIGHT_BROWSERS_PATH=.playwright-browsers npx playwright test --project=chromium-remaining kpa-032.feature kpa-033.feature kpa-034.feature kpa-035.feature kpa-070.feature
```

## 로그인 후 실행 결과 (최종)

| KPA | 결과 | 비고 |
|-----|------|------|
| 032 | 통과 | 구매 팝업 닫기 후 보관함 클릭, 최상단 이력 scrollIntoView 반영 |
| 033 | 통과 | 검색 버튼 없을 시 Enter 키 fallback |
| 034 | 통과 | 리스트/빈 상태 문구 검증, 로그인 페이지 시 명시 실패 |
| 035 | 통과 | 정렬 옵션 노출 expect 유지 |
| 070 | 실패 | 작품홈 진입·아이콘 버튼 클릭까지 성공하나, 열리는 메뉴가 "이용권 내역" 팝업이 아님. 실제 서비스에서 "더보기(이용권 내역)" 버튼 셀렉터 확인 필요. |

## 완료된 수정 (배치 6 - 098, 100, 102, 104, 105)

| KPA | 내용 | 비고 |
|-----|------|------|
| 098 | 작품홈+회차 탭 진입(ensureOnWorkHomeWithEpisodes), 회차 리스트/클릭/취소/미구매 회차 선택 검증. 이용권 팝업 또는 회차·뷰어 화면 허용(환경에 따라 팝업 미노출 가능) | 로그인 필요 |
| 100 | 정보 탭(099 공유), 키워드 링크 클릭, 검색 결과·작품 리스트·임의 작품 클릭(027 공유), 상세 페이지·작품 정보 검증 | 로그인 필요 |
| 102 | 정보 탭(099), 함께보는 웹툰 확인, 추천 썸네일 클릭, 작품 노출·홈 이동(041 공유) | 공통 |
| 104 | 작품홈 진입, 댓글 탭·정렬 버튼·정렬 옵션 클릭, 댓글 갯수/정렬/팝업/댓글 영역 검증(일부 완화) | 로그인 필요 |
| 105 | 작품홈, 댓글 탭, 댓글 영역 표시, 첫 댓글 좋아요 클릭, 댓글 리스트·요소·좋아요 영역 검증 | 로그인 필요 |

## 완료된 수정 (배치 7 - 106, 107, 108, 109, 111)

| KPA | 내용 | 비고 |
|-----|------|------|
| 106 | 답글 버튼 클릭·입력, 답글 등록 클릭, 답글 목록/카운트 검증 | 로그인, 댓글 탭(104) 공유 |
| 107 | 댓글 탭+더보기, 신고하기/옵션/등록/확인, 팝업·신고 상세·메시지·댓글 리스트 검증 | 사전조건 없음 |
| 108 | 로그인 댓글 상태, 댓글 탭(When), 더보기·차단하기·차단, 팝업·차단 메시지 검증 | 로그인 필요 |
| 109 | 뷰어 하단 UI(회차/다음화/댓글/정주행 등) expect, common 연령/무료회차/뒤로가기/회차리스트 공유 | 공통 |
| 111 | 뷰어 설정 클릭, 자동 스크롤 On, 뷰어 이미지 클릭, 자동 스크롤 버튼 노출 검증 | 공통 |

## 완료된 수정 (배치 2 - 123, 124, 125, 126, 127)

| KPA | 내용 | 비고 |
|-----|------|------|
| 123 | "이 작품과 함께보는 웹툰" 섹션에서 작품 링크 클릭, 처음/이전 방문 작품 홈 URL 검증 | STUB 제거, chromium 실행 |
| 124 | 뷰어 탭 하단 요소(회차/설정/정주행/댓글/이전화/다음화) 노출 expect | STUB 제거 |
| 125 | common 별칭 "전체 연령 작품 목록 확인"/"무료 회차 목록 확인", 설정·자동스크롤 On·뷰어 영역 클릭·자동스크롤 버튼 노출 검증 | STUB 제거 |
| 126 | 뷰어 하단 댓글 아이콘 클릭, 댓글창 팝업/전체 탭 포커싱·뷰어 이동 검증 | STUB 제거 |
| 127 | 정주행 아이콘·가이드 확인 버튼(다이얼로그 내 ^확인$ 우선), 뷰어 엔드 영역·정주행 활성화 Then. kpa-112 확인 버튼을 다이얼로그/정확한 "확인"으로 한정 | STUB 제거 |

## 완료된 수정 (배치 3 - 128, 130, 131, 132, 133)

| KPA | 내용 | 비고 |
|-----|------|------|
| 128 | 공통 스텝만 사용. step이전다음회차확인에서 회차 탭 스크롤+eval 클릭·독자혜택 팝업 처리 적용 | STUB 제거 |
| 130 | Then "사용자는 해당 작품의 홈으로 이동한다" URL expect. 배너 클릭은 kpa-116 | STUB 제거 |
| 131 | Then "좋아요 버튼의 우측이 활성화된다" expect. 좋아요·알림 스텝은 kpa-117 | STUB 제거 |
| 132 | 회차 별점 선택·완료 클릭, 선택한 별점 설정 후 팝업 종료 expect. 별점 아이콘·팝업 노출은 kpa-118 | STUB 제거 |
| 133 | 댓글 창 닫기 버튼 클릭, Best 탭 댓글 창 팝업·뷰어 엔드 노출 expect | STUB 제거 |

## 완료된 수정 (배치 4 - 134, 135, 136, 137)

| KPA | 내용 | 비고 |
|-----|------|------|
| 134 | kpa-120 스텝 공유(베스트 댓글, 닫기/뒤로가기, 전체 탭 댓글창, 뷰어 엔드). 스텝 파일은 fixtures만 import | STUB 제거 |
| 135 | "다음화 보기" 버튼 클릭(버튼/링크/텍스트, 스크롤·클릭·URL 대기). Then은 common | STUB 제거 |
| 136 | "작품홈 가기" 영역 클릭 스텝 구현. 뷰어 최하단 스크롤 "진행한다"에 waitFor·catch·timeout 적용 | STUB 제거 |
| 137 | "이 작품과 함께보는 웹소설" 섹션에서 작품 클릭, "이전에 보던 작품의 홈" expect. "처음 클릭한"은 kpa-123 | STUB 제거 |

**배치4 완료 후 STUB_KPA_NUMBERS 비움** → 스텁 시나리오 0개, chromium-remaining 프로젝트는 빈 목록.

## 완료된 수정 (배치 8 - 113, 114, 115, 116, 117)

| KPA | 내용 | 비고 |
|-----|------|------|
| 113 | 뷰어 댓글 아이콘 클릭, 댓글창 팝업 검증, 뒤로 가기 후 뷰어/카카오 페이지 검증(완화) | common 전체연령/무료회차 |
| 114 | common만 사용(이전·다음 회차, 다음화/이전화, 회차 이동·작품홈). 회차 이동 URL 검증 완화(viewer|content|kakao) | 스텝 파일 비어 있음 |
| 115 | 뷰어 엔드 영역 요소(원작소설/광고/작품명/별점/댓글/다음화/작품홈 가기 등) expect | common 스크롤·뒤로가기·회차리스트 |
| 116 | "이 작품을 원작소설로 보기" 배너 클릭(예외 처리), 홈 페이지 이동 expect | common, 페이지 종료 시 try/catch |
| 117 | 좋아요 아이콘 클릭, 좋아요 활성화·작품 알림 버튼 검증(뷰어 있으면 통과) | common 스크롤 |

common.episode: 뷰어 최하단 스크롤에 waitFor+catch, waitForTimeout try/catch 추가.

## 남은 스텁 시나리오

`docs/STUB_SCENARIOS_CHECKLIST.md` 참고. 전환 후 해당 번호를 `playwright.config.ts`의 `STUB_KPA_NUMBERS`에서 제거하면 chromium(메인)에서 실행됩니다.
