# 뷰어 KPA-104~120 실패 케이스 원인 정리

이전 헤드리스 실행에서 보고된 실패 6건(105, 107, 110, 112, 114, 120)에 대한 코드 기준 원인 분석입니다.

---

## 1. KPA-105 – 댓글 작성일자 검증 실패

**실패 스텝:** `각 댓글에는 닉네임, 작성일자, 댓글 내용, 좋아요 수, 싫어요 수, 답글 버튼, 더보기 버튼이 표시된다`

**위치:** `steps/kpa-105.steps.ts` 62~80행

**원인:**  
작성일자 검사가 아래 정규식 한 종류만 사용합니다.

```ts
const hasDate =
  (await page.locator("text=/\\d{1,2}분 전|\\d{1,2}시간 전|어제|\\d{4}\\.\\d{1,2}\\.\\d{1,2}/").count()) > 0;
```

- **포함:** `N분 전`, `N시간 전`, `어제`, `YYYY.MM.DD`
- **미포함:** `오늘`, `N일 전`, `방금`, `YYYY-MM-DD`, `YYYY/MM/DD` 등 다른 표기

실제 서비스에서 위에 없는 형식으로만 날짜를 보여주면 `hasDate`가 false가 되어 `expect(hasDate).toBe(true)`에서 실패합니다.

**개선 제안:**  
서비스에 실제로 노출되는 날짜 텍스트를 확인한 뒤, 해당 형식을 추가하거나 `hasDate` 검사 방식을 유연하게 조정(여러 패턴 OR, 또는 “날짜처럼 보이는 텍스트” 존재 여부 등)하는 것이 좋습니다.

---

## 2. KPA-107 – 더보기 레이어/옵션 미노출

**관련 스텝:**  
- `사용자가 첫번째 댓글 우측 끝의 [더보기] 버튼을 클릭한다`  
- `팝업에는 다음 옵션이 포함되어야 한다` (신고하기, 차단하기, 취소 등)

**위치:** `steps/kpa-107.steps.ts` 28~36행, 84~108행

**원인:**

1. **더보기 버튼 셀렉터**  
   첫 댓글 영역을 `commentMarker.locator("xpath=../../../..")`로 잡고, 그 안에서 `img[alt="더보기"], img[alt*="더보기"]`만 사용합니다.  
   - DOM 구조가 바뀌면 xpath가 잘못된 영역을 가리킴.  
   - 더보기 버튼이 아이콘만 있고 `alt`가 없거나, “더보기”가 아닌 문구(예: “메뉴”, “⋯”)면 매칭되지 않음.  
   - 그 결과 `waitFor({ state: "visible", timeout: 12000 })`에서 타임아웃되거나, 클릭이 안 되어 레이어가 안 뜸.

2. **팝업 옵션 검증**  
   `assertPopupOptions`에서 “신고하기”, “차단하기”, “취소” 등 지정 텍스트가 보이는지 확인합니다.  
   - 더보기 메뉴가 실제로 열리지 않으면 옵션이 없어서 실패.  
   - 옵션 문구가 서비스와 다르면(예: “취소” 대신 “닫기”) 역시 실패.

**개선 제안:**  
- 실제 페이지에서 “첫 댓글 더보기” 요소의 태그/속성/텍스트를 확인하고, `alt`/role/텍스트 기반 셀렉터를 보강.  
- xpath 의존도를 줄이고, 댓글 리스트 + “더보기” 버튼 조합 등 더 안정적인 locator로 변경 검토.  
- 기대 옵션 문구를 서비스 UI에 맞게 수정하거나, 여러 후보 텍스트를 허용하도록 변경.

---

## 3. KPA-110 – 페이지 뷰어 전환 후 hasPageView 검증 실패

**실패 스텝:** `이미지 뷰어 방식이 페이지 뷰어 타입으로 변경된다.`

**위치:** `steps/kpa-110.steps.ts` 77~84행

**원인:**  
페이지 뷰어 전환 성공 여부를 아래 조건으로만 판단합니다.

```ts
const hasPageView =
  (await page.locator('img[alt="왼쪽 화살표"], img[alt="오른쪽 화살표"]').count()) >= 1 ||
  (await page.getByText(/이전화|다음화/).count()) > 0 ||
  (await page.locator('[data-test*="viewer-navbar"]').count()) > 0;
```

- 실제 UI에서 화살표/이전·다음/네비바가 위와 다른 속성·텍스트·테스트 id를 쓰면 `hasPageView`가 false.
- 전환 직후 렌더가 늦어지면, 짧은 대기만으로는 요소가 아직 없을 수 있음.

**개선 제안:**  
- 페이지 뷰어 모드일 때 실제로 노출되는 요소를 개발자 도구로 확인한 뒤, 해당 셀렉터를 추가.  
- `waitForTimeout` 또는 해당 요소에 대한 `waitFor({ state: "visible", timeout: ... })`를 넣어 타이밍 이슈 완화.

---

## 4. KPA-112, KPA-114 – toHaveURL(/\/viewer\//i) 실패

**실패 스텝:** `뷰어 탭 상단에 다음 UI 요소들이 노출된다:` (112/114 공통)

**위치:** `steps/kpa-112.steps.ts` 6~8행

**원인:**  
스텝 진입 시 가장 먼저 URL을 검사합니다.

```ts
await expect(page).toHaveURL(/\/viewer\//i, { timeout: 5000 });
```

- 무료 회차 **진입 → 클릭** 순서가 맞지 않았을 때, “클릭”이 회차 목록이 열리기 전에 실행되면 뷰어로 이동하지 않아 URL이 `/content/...` 등에 머무름.  
- 그 상태에서 5초 안에 `/viewer/`로 바뀌지 않으면 위 assertion에서 실패.

이미 **진입 → 클릭** 순서로 feature/spec을 되돌린 상태이므로, 동일 환경에서 다시 실행하면 통과 가능성이 있습니다.  
(최근 Cursor 샌드박스 실행은 브라우저 기동 실패로 모든 케이스가 실패한 상태라, 이 변경 효과는 로컬 헤드리스로만 확인 가능합니다.)

**개선 제안:**  
- 로컬에서 112, 114만 다시 실행해 URL/뷰어 진입이 정상인지 확인.  
- 여전히 실패하면 “무료 회차에 진입한다” 단계에서 뷰어 URL까지 기다리거나, 이 Then 직전에 `waitForURL(/\/viewer\//i)`를 한 번 더 넣는 방식 검토.

---

## 5. KPA-120 – BEST 영역 10초 내 visible 타임아웃

**실패 스텝:** `사용자가 베스트 댓글 영역을 클릭한다`

**위치:** `steps/kpa-120.steps.ts` 6~13행

**원인:**  
베스트 영역을 아래처럼 찾고 10초 동안 visible을 기다립니다.

```ts
const bestArea = page.getByText(/^BEST$/i).first()
  .or(page.getByText(/베스트\s*댓글|Best\s*댓글/i).first());
await bestArea.waitFor({ state: "visible", timeout: 10000 });
```

- **스크롤:** 베스트 댓글 영역이 뷰어 하단에 있어서, 스크롤 전에는 DOM에 없거나 보이지 않을 수 있음.  
- **렌더 시점:** 헤드리스에서 lazy load 등으로 10초 안에 안 뜨면 타임아웃.  
- **문구/구조:** 실제 노출 텍스트가 “BEST”가 아니거나(예: “인기 댓글”), 다른 컨테이너 안에 있으면 셀렉터가 매칭되지 않음.

**개선 제안:**  
- “베스트 댓글”/“BEST”가 나오기 전에 **뷰어 최하단까지 스크롤**하는 스텝이 선행되는지 feature 확인.  
- 필요하면 이 스텝 내부에서 해당 영역으로 `scrollIntoViewIfNeeded()` 후 `waitFor`.  
- 실제 서비스 마크업에 맞게 셀렉터 보강(예: `data-test`, role, 상위 컨테이너).  
- 10초로 부족하면 timeout을 15초 등으로 늘리거나, 재시도 로직 검토.

---

## 요약 표

| 케이스 | 실패 지점 | 원인 요약 |
|--------|-----------|-----------|
| 105 | 작성일자 검증 | 날짜 형식 정규식이 서비스 표기와 불일치 |
| 107 | 더보기 클릭/팝업 옵션 | 더보기 셀렉터·DOM 구조·옵션 문구와 실제 UI 불일치 |
| 110 | 페이지 뷰어 변경 검증 | 페이지 뷰어 UI 셀렉터/렌더 타이밍과 불일치 |
| 112, 114 | 뷰어 URL 검증 | (진입→클릭 순서 복구로 완화 가능, 로컬 재검증 필요) |
| 120 | 베스트 영역 클릭 | 스크롤/렌더 타이밍 또는 BEST 텍스트·구조 불일치 |

위 내용을 반영해 셀렉터·대기·검증 조건을 조정하면, 동일 시나리오에서 재현률을 낮출 수 있습니다.
